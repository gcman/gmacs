(require 'cl-lib)
(require 'dash)

(define-minor-mode pretty-math-mode
  "Minor mode for math"
  :init-value nil
  (font-lock-fontify-buffer)
  (if pretty-math-mode
      (font-lock-add-keywords nil (gm/pretty-math-keywords))
    (font-lock-remove-keywords nil (gm/pretty-math-keywords))))

(defvar gm/math-greek-upper
  '(("Gamma" "Î“")
    ("Delta" "Î”")
    ("Epsilon" "Î•")
    ("Theta" "Î˜")
    ("Lambda" "Î›")
    ("Xi" "Î")
    ("Pi" "Î ")
    ("Sigma" "Î£")
    ("Upsilon" "Î¥")
    ("Phi" "Î¦")
    ("Psi" "Î¨")
    ("Omega" "Î©")))

(defvar gm/math-greek-lower
  '(("alpha" "Î±")
    ("beta" "Î²")
    ("gamma" "Î³")
    ("delta" "Î´")
    ("epsilon" "Îµ")
    ("zeta" "Î¶")
    ("eta" "Î·")
    ("theta" "Î¸")
    ("iota" "Î¹")
    ("kappa" "Îº")
    ("lambda" "Î»")
    ("mu" "Î¼")
    ("nu" "Î½")
    ("xi" "Î¾")
    ("omicron" "Î¿")
    ("pi" "Ï€")
    ("rho" "Ï")
    ("sigma" "Ïƒ")
    ("tau" "Ï„")
    ("upsilon" "Ï…")
    ("phi" "Ï•")
    ("chi" "Ï‡")
    ("psi" "Ïˆ")
    ("omega" "Ï‰")
    ("varphi" "Ï†")
    ("vartheta" "Ï‘")
    ("varpi" "Ï–")
    ("varrho" "Ï±")
    ("varsigma" "Ï‚")))

(defvar gm/math-vectors
  (append
   (cl-loop for i from 65 to 90
            collect (list (concat "vec " (char-to-string i))
                          (char-to-string (+ i 120211))))
   (cl-loop for i from 97 to 122
            collect (list (concat "vec " (char-to-string i))
                          (char-to-string (+ i 120205))))))

(defvar gm/math-letters
  (append
   gm/math-greek-lower
   gm/math-greek-upper
   gm/math-vectors
   '(("aleph" "â„µ")
     ("hbar" "Ä§")
     ("ell" "â„“")
     ("wp" "â„˜")
     ("partial" "âˆ‚")
     ("pd" "âˆ‚")
     ("N" "ğ—¡")
     ("Z" "ğ—­")
     ("Q" "ğ—¤")
     ("R" "ğ—¥")
     ("C" "ğ—–")
     ("F" "ğ—™")
     ("Prob" "ğ—£")
     ("E" "ğ—˜"))))

(defvar gm/math-arrows
  '(("rightarrow" "â†’")        ; Directions
    ("leftarrow" "â†")
    ("leftrightarrow" "â†”")
    ("Rightarrow" "â‡’")
    ("Leftarrow" "â‡")
    ("Leftrightarrow" "â‡”")
    ("uparrow" "â†‘")
    ("downarrow" "â†“")
    ("updownarrow" "â†•")
    ("Uparrow" "â‡‘")
    ("Downarrow" "â‡“")
    ("Updownarrow" "â‡•")
    ("nearrow" "â†—")
    ("searrow" "â†˜")
    ("nwarrow" "â†–")
    ("swarrow" "â†™")
    ("Longrightarrow" "âŸ¹")  ; Long arrows
    ("implies" "âŸ¹")  ; Long arrows
    ("longrightarrow" "âŸ¶")
    ("longleftarrow" "âŸµ")
    ("Longleftarrow" "âŸ¸")
    ("impliedby" "âŸ¸")
    ("longmapsto" "âŸ¼")
    ("longleftrightarrow" "âŸ·")
    ("Longleftrightarrow" "âŸº")
    ("iff" "âŸº")
    ("leftharpoonup" "â†¼")     ; Special Arrows
    ("leftharpoondown" "â†½")
    ("rightharpoonup" "â‡€")
    ("rightharpoondown" "â‡")
    ("rightleftharpoons" "â‡Œ")
    ("hookrightarrow" "â†ª")
    ("hookleftarrow" "â†©")))

(defvar gm/math-operators
  '(("bigvee" "â‹")
    ("bigwedge" "â‹€")
    ("biguplus" "â¨„")
    ("bigcap" "â‹‚")
    ("bigcup" "â‹ƒ")
    ("nabla" "âˆ‡")
    ("prod" "âˆ")
    ("coprod" "âˆ")
    ("int" "âˆ«")
    ("iint" "âˆ¬")
    ("iiint" "âˆ­")
    ("oint" "âˆ®")
    ("oiint" "âˆ¯")
    ("oiiint" "âˆ°")
    ("sum" "âˆ‘")
    ("bigotimes" "â¨‚")
    ("bigoplus" "â¨")
    ("bigodot" "â¨€")
    ("bigsqcup" "â¨†")
    ("bigcirc" "â—¯")))

(defvar gm/math-spaced
  (append
   gm/math-arrows
  '(("geq" "â‰¥")
    ("ge" "â‰¥")
    ("leq" "â‰¤")
    ("le" "â‰¤")
    ("neq" "â‰ ")
    ("land" "âˆ§")
    ("lor" "âˆ¨")
    ("neg" "Â¬")
    ("forall" "âˆ€")
    ("exists" "âˆƒ")
    ("Diamond" "â‹„")
    ("Box" "â–¡")
    ("models" "âŠ§")
    ("bot" "âŠ¥")
    ("top" "âŠ¤")
    ("mid" "|")
    ("cup" "âˆª")
    ("cap" "âˆ©")
    ("setminus" "âˆ–")
    ("minus" "âˆ–")
    ("subseteq" "âŠ†")
    ("subset" "âŠ‚")
    ("in" "âˆŠ")
    ("ni" "âˆ‹")
    ("notin" "âˆ‰")
    ("mapsto" "â†¦")
    ("to" "â†’")
    ("times" "Ã—")
    ("equiv" "â‰¡")
    ("sqcap" "âŠ“")
    ("sqcup" "âŠ”")
    ("uplus" "âŠ")
    ("amalg" "â¨¿")
    ("odot" "âŠ™")
    ("oslash" "âŠ˜")
    ("otimes" "âŠ—")
    ("ominus" "âŠ–")
    ("oplus" "âŠ•")
    ("mp" "âˆ“")
    ("pm" "Â±")
    ("cdot" "â‹…")
    ("ast" "âˆ—")
    ("propto" "âˆ")
    ("sqsubseteq" "âŠ‘")
    ("sqsupseteq" "âŠ’")
    ("parallel" "âˆ¥")
    ("dashv" "âŠ£")
    ("vdash" "âŠ¢")
    ("succ" "â‰»")
    ("prec" "â‰º")
    ("approx" "â‰ˆ")
    ("succeq" "â‰½")
    ("preceq" "â‰¼")
    ("supset" "âŠƒ")
    ("supseteq" "âŠ‡")
    ("gg" "â‰«")
    ("ll" "â‰ª")
    ("sim" "âˆ¼")
    ("simeq" "â‰ƒ")
    ("asymp" "â‰")
    ("smile" "âŒ£")
    ("frown" "âŒ¢")
    ("bowtie" "â‹ˆ")
    ("models" "âŠ§")
    ("Vert" "âˆ¥")
    ("cong" "â‰…")
    ("doteq" "â‰")
    ("triangleleft" "â—")
    ("triangleright" "â–·")
    ("bigtriangleup" "â–³")
    ("bigtriangledown" "â–½")
    ("circ" "âˆ˜")
    ("wedge" "âˆ§")
    ("vee" "âˆ¨")
    ("intprod" "ï½£"))))

(defvar gm/math-unspaced
  (append
   gm/math-operators
   gm/math-letters
   '(("infty" "âˆ")
     ("emptyset" "âˆ…")
     ("dots" "â€¦")
     ("cdots" "â‹¯")
     ("vdots" "â‹®")
     ("ddots" "â‹±")
     ("langle" "âŸ¨")
     ("rangle" "âŸ©")
     ("rceil" "âŒ‰")
     ("lceil" "âŒˆ")
     ("rfloor" "âŒ‹")
     ("lfloor" "âŒŠ")
     ("dagger" "â€ " )
     ("dag" "â€ ")
     ("ddag" "â€¡")
     ("S" "Â§")
     ("star" "â˜…")
     ("bullet" "â€¢")
     ("vDash" "âŠ¨")
     ("surd" "âˆš")
     ("angle" "âˆ ")
     ("triangle" "â–³")
     ("flat" "â™­")
     ("natural" "â™®")
     ("sharp" "â™¯")
     ("clubsuit" "â™£")
     ("diamondsuit" "â™¢")
     ("heartsuit" "â™¡")
     ("spadesuit" "â™ ")
     ("D" "D")
     ("left(" "âª")
     ("right)" "â«")
     ("left\\[" "[")
     ("right\\]" "]"))))

(defvar gm/spaced-custom
  '(("Div" [?\s (Br . Bl) ?\s (Bc . Br) ?âˆ‡ (Br . Bc) ?\s (Br . Bc) ?\s (Bc . Bl) ?Â·])
    ("Lapl" [?\s (Bc . Bc) ?\s (Bc . Br) ?âˆ†])
    ("Grad" [?\s (Bc . Bc) ?\s (Bc . Br) ?âˆ‡])
    ("Curl" [?\s (Br . Bl) ?\s (Bc . Br) ?âˆ‡ (Br . Bc) ?\s (Br . Bc) ?\s (Bc . Bl) ?Ã—])
    ("int" [?\s (Bc . Bc) ?\s (Bc . Br) ?âˆ«])
    ("dd" [?\s (Br . Bc) ?ğ–½])))

(defvar gm/math-commands
  '(("bra" "âŸ¨" "|")
    ("ket" "|" "âŸ©")
    ("abs" "|" "|")
    ("norm" "â€–" "â€–")))

(defun gm/math-regexp-unspaced (name symbol)
  (list (list (format "\\(\\\\%s{}\\)" name) symbol)
        (list (format "\\(\\\\%s\\)[^[:alnum:]{]" name) symbol)))

(defun gm/math-regexp-spaced (name symbol)
  (setq symbol `[?\s (Br . Bl) ?\s (Bc . Bc) ,(string-to-char symbol)])
  (list (list (format "\\(\\\\%s\\( \\|{}\\)\\)" name) symbol)
        (list (format "\\([ ]?\\\\%s\\)[^[:alnum:]{ ]" name) symbol)))

(defun gm/math-regexp-spaced-custom (name symbol)
  (list (format "\\(\\\\%s\\( \\|{}\\)\\)" name) symbol))

(defun gm/math-replacements ()
  (append
   (-flatten-n 1 (--map (apply 'gm/math-regexp-spaced it) gm/math-spaced))
   (-flatten-n 1 (--map (apply 'gm/math-regexp-unspaced it) gm/math-unspaced))
   (--map (apply 'gm/math-regexp-spaced-custom it) gm/spaced-custom)))

(defun gm/curry (fun &rest args)
  "Partially apply FUN to ARGS.  The result is a new function.
This idiom is preferred over `lexical-let'."
  `(lambda (&rest more) (apply ',fun (append ',args more))))

(defun gm/pretty-match-font-lock-helper (symbol &optional match-num)
  (unless match-num (setq match-num 1))
  `(,match-num (compose-region
                (match-beginning ,match-num)
                (match-end ,match-num)
                ,symbol
                'decompose-region)))

(defun gm/pretty-math-command-matcher (command limit)
  (let ((end-brace1 nil)
        (end-brace2 nil)
        (data nil))
    (catch 'done
      (while (re-search-forward (concat "\\\\" command "{") limit t)
        (when (condition-case nil
                  (save-excursion
                    (backward-char)
                    (forward-sexp)
                    (when (eq (char-before) 125)  ;; 125 is "}"
                      (backward-char)
                    (setq end-brace1 (point-marker))
                    (forward-char)
                    (setq end-brace2 (point-marker))))
                (error nil))
          (setq data (match-data))
          (set-match-data (list
                           (nth 0 data)
                           end-brace2
                           (nth 0 data)
                           (nth 1 data)
                           end-brace1
                           end-brace2))
          (throw 'done (point)))))))

(defun gm/pretty-math-gen-font-lock-keywords (name symbol &optional name2 symbol2)
  `(,name ,(gm/pretty-match-font-lock-helper symbol)))

(defun gm/pretty-math-gen-font-lock-commands (name open-delim close-delim)
  `(,(gm/curry 'gm/pretty-math-command-matcher name)
    ,(gm/pretty-match-font-lock-helper open-delim 1)
    ,(gm/pretty-match-font-lock-helper close-delim 2)))

(defun gm/pretty-math-keywords ()
  (append
   (--map (apply 'gm/pretty-math-gen-font-lock-keywords it) (gm/math-replacements))
   (--map (apply 'gm/pretty-math-gen-font-lock-commands it) gm/math-commands)))

(provide 'gm-pretty-math)
