(require 'cl-lib)
(require 'dash)

(defun substitute-pattern-with-unicode-symbol (pattern symbol)
  "Add a font lock hook to replace the matched part of PATTERN with the Unicode
symbol SYMBOL.
Symbol can be the symbol directly, no lookup needed."
  (interactive)
  (font-lock-add-keywords
   nil
   `((,pattern
      (0 (progn
	         (compose-region (match-beginning 1) (match-end 1)
	   		                   ,symbol
	   		                   'decompose-region)
	         nil))))))

(defun substitute-patterns-with-unicode-symbol (patterns)
  "Mapping over PATTERNS, calling SUBSTITUTE-PATTERN-WITH-UNICODE for each of the patterns."
  (mapcar (lambda (x)
            (substitute-pattern-with-unicode-symbol (car x)
						                                        (cdr x)))
          patterns))

(defvar gm/math-greek-upper
  '(("Gamma" "Î“")
    ("Delta" "Î”")
    ("Epsilon" "Î•")
    ("Theta" "Î˜")
    ("Lambda" "Î›")
    ("Xi" "Î")
    ("Pi" "Î ")
    ("Sigma" "Î£")
    ("Upsilon" "Î¥")
    ("Phi" "Î¦")
    ("Psi" "Î¨")
    ("Omega" "Î©")))

(defvar gm/math-greek-lower
  '(("alpha" "Î±")
    ("beta" "Î²")
    ("gamma" "Î³")
    ("delta" "Î´")
    ("epsilon" "Îµ")
    ("zeta" "Î¶")
    ("eta" "Î·")
    ("theta" "Î¸")
    ("iota" "Î¹")
    ("kappa" "Îº")
    ("lambda" "Î»")
    ("mu" "Î¼")
    ("nu" "Î½")
    ("xi" "Î¾")
    ("omicron" "Î¿")
    ("pi" "Ï€")
    ("rho" "Ï")
    ("sigma" "Ïƒ")
    ("tau" "Ï„")
    ("upsilon" "Ï…")
    ("phi" "Ï•")
    ("chi" "Ï‡")
    ("psi" "Ïˆ")
    ("omega" "Ï‰")
    ("varphi" "Ï†")
    ("vartheta" "Ï‘")
    ("varpi" "Ï–")
    ("varrho" "Ï±")
    ("varsigma" "Ï‚")))

(defvar gm/math-vectors
  (append
   (cl-loop for i from 65 to 90
            collect (list (concat "vec " (char-to-string i))
                          (char-to-string (+ i 120211))))
   (cl-loop for i from 97 to 122
            collect (list (concat "vec " (char-to-string i))
                          (char-to-string (+ i 120205))))))

(defvar gm/math-letters
  (append
   gm/math-greek-lower
   gm/math-greek-upper
   gm/math-vectors
   '(("aleph" "â„µ")
     ("hbar" "â„")
     ("ell" "ğ“")
     ("wp" "â„˜")
     ("Re" "â„œ")
     ("Im" "â„‘")
     ("partial" "âˆ‚")
     ("N" "ğ—¡")
     ("Z" "ğ—­")
     ("Q" "ğ—¤")
     ("R" "ğ—¥")
     ("C" "ğ—–")
     ("F" "ğ—™"))))

(defvar gm/math-arrows
  '(("rightarrow" "â†’")        ; Directions
    ("leftarrow" "â†")
    ("leftrightarrow" "â†”")
    ("Rightarrow" "â‡’")
    ("Leftarrow" "â‡")
    ("Leftrightarrow" "â‡”")
    ("uparrow" "â†‘")
    ("downarrow" "â†“")
    ("updownarrow" "â†•")
    ("Uparrow" "â‡‘")
    ("Downarrow" "â‡“")
    ("Updownarrow" "â‡•")
    ("nearrow" "â†—")
    ("searrow" "â†˜")
    ("nwarrow" "â†–")
    ("swarrow" "â†™")
    ("Longrightarrow" "âŸ¹")  ; Long arrows
    ("longrightarrow" "âŸ¶")
    ("longleftarrow" "âŸµ")
    ("Longleftarrow" "âŸ¸")
    ("longmapsto" "âŸ¼")
    ("longleftrightarrow" "âŸ·")
    ("Longleftrightarrow" "âŸº")
    ("leftharpoonup" "â†¼")     ; Special Arrows
    ("leftharpoondown" "â†½")
    ("rightharpoonup" "â‡€")
    ("rightharpoondown" "â‡")
    ("rightleftharpoons" "â‡Œ")
    ("hookrightarrow" "â†ª")
    ("hookleftarrow" "â†©")))

(defvar gm/math-operators
  '(("bigvee" "â‹")
    ("bigwedge" "â‹€")
    ("biguplus" "â¨„")
    ("bigcap" "â‹‚")
    ("bigcup" "â‹ƒ")
    ("nabla" "âˆ‡")
    ("prod" "âˆ")
    ("coprod" "âˆ")
    ("int" "âˆ«")
    ("iint" "âˆ¬")
    ("iiint" "âˆ­")
    ("oint" "âˆ®")
    ("oiint" "âˆ¯")
    ("oiiint" "âˆ°")
    ("sum" "âˆ‘")
    ("bigotimes" "â¨‚")
    ("bigoplus" "â¨")
    ("bigodot" "â¨€")
    ("bigsqcup" "â¨†")
    ("bigcirc" "â—¯")))

(defvar gm/math-spaced
  (append
   gm/math-arrows
  '(("geq" "â‰¥")
    ("ge" "â‰¥")
    ("leq" "â‰¤")
    ("le" "â‰¤")
    ("neq" "â‰ ")
    ("land" "âˆ§")
    ("lor" "âˆ¨")
    ("neg" "Â¬")
    ("forall" "âˆ€")
    ("exists" "âˆƒ")
    ("Diamond" "â‹„")
    ("Box" "â–¡")
    ("models" "âŠ§")
    ("bot" "âŠ¥")
    ("top" "âŠ¤")
    ("mid" "|")
    ("cup" "âˆª")
    ("cap" "âˆ©")
    ("setminus" "âˆ–")
    ("minus" "âˆ–")
    ("subseteq" "âŠ†")
    ("subset" "âŠ‚")
    ("in" "âˆŠ")
    ("ni" "âˆ‹")
    ("notin" "âˆ‰")
    ("mapsto" "â†¦")
    ("to" "â†’")
    ("times" "Ã—")
    ("equiv" "â‰¡")
    ("sqcap" "âŠ“")
    ("sqcup" "âŠ”")
    ("uplus" "âŠ")
    ("amalg" "â¨¿")
    ("odot" "âŠ™")
    ("oslash" "âŠ˜")
    ("otimes" "âŠ—")
    ("ominus" "âŠ–")
    ("oplus" "âŠ•")
    ("mp" "âˆ“")
    ("pm" "Â±")
    ("cdot" "â‹…")
    ("ast" "âˆ—")
    ("propto" "âˆ")
    ("sqsubseteq" "âŠ‘")
    ("sqsupseteq" "âŠ’")
    ("parallel" "âˆ¥")
    ("dashv" "âŠ£")
    ("vdash" "âŠ¢")
    ("succ" "â‰»")
    ("prec" "â‰º")
    ("approx" "â‰ˆ")
    ("succeq" "â‰½")
    ("preceq" "â‰¼")
    ("supset" "âŠƒ")
    ("supseteq" "âŠ‡")
    ("gg" "â‰«")
    ("ll" "â‰ª")
    ("sim" "âˆ¼")
    ("simeq" "â‰ƒ")
    ("asymp" "â‰")
    ("smile" "âŒ£")
    ("frown" "âŒ¢")
    ("bowtie" "â‹ˆ")
    ("models" "âŠ§")
    ("Vert" "âˆ¥")
    ("cong" "â‰…")
    ("doteq" "â‰"))))

(defvar gm/math-unspaced
  (append
   gm/math-operators
   gm/math-letters
   '(("infty" "âˆ")
     ("emptyset" "âˆ…")
     ("dots" "â€¦")
     ("cdots" "â‹¯")
     ("vdots" "â‹®")
     ("ddots" "â‹±")
     ("langle" "âŸ¨")
     ("rangle" "âŸ©")
     ("rceil" "âŒ‰")
     ("lceil" "âŒˆ")
     ("rfloor" "âŒ‹")
     ("lfloor" "âŒŠ")
     ("dagger" "â€ " )
     ("dag" "â€ ")
     ("ddag" "â€¡")
     ("S" "Â§")
     ("triangleleft" "â—")
     ("triangleright" "â–·")
     ("bigtriangleup" "â–³")
     ("bigtriangledown" "â–½")
     ("star" "â˜…")
     ("vDash" "âŠ¨")
     ("circ" "âˆ˜")
     ("surd" "âˆš")
     ("angle" "âˆ ")
     ("triangle" "â–³")
     ("flat" "â™­")
     ("natural" "â™®")
     ("sharp" "â™¯")
     ("clubsuit" "â™£")
     ("diamondsuit" "â™¢")
     ("heartsuit" "â™¡")
     ("spadesuit" "â™ "))))

(defvar gm/spaced-after
  '(("Div" [?\s (Br . Bl) ?\s (Bc . Br) ?âˆ‡ (Br . Bc) ?\s (Br . Bc) ?\s (Bc . Bl) ?Â·])
    ("Grad" [?\s (Bc . Bc) ?\s (Bc . Br) ?âˆ‡])
    ("Curl" [?\s (Br . Bl) ?\s (Bc . Br) ?âˆ‡ (Br . Bc) ?\s (Br . Bc) ?\s (Bc . Bl) ?Ã—])
    ("int" [?\s (Bc . Bc) ?\s (Bc . Br) ?âˆ«])))

(defvar gm/math-commands
  '(("dd" [?\s (Br . Bl) ?ğ–½] "")
    ("pd" [?\s (Br . Bl) ?âˆ‚] "")))

(defun gm/math-regexp-unspaced (name symbol)
  (list (cons (format "\\(\\\\%s{}\\)" name) symbol)
        (cons (format "\\(\\\\%s\\)[^[:alnum:]{]" name) symbol)))

(defun gm/math-regexp-spaced (name symbol)
  (setq symbol `[?\s (Br . Bl) ?\s (Bc . Bc) ,(string-to-char symbol)])
  (list (cons (format "\\(\\\\%s\\( \\|{}\\)\\)" name) symbol)
        (cons (format "\\([ ]?\\\\%s\\)[^[:alnum:]{ ]" name) symbol)))

(defun gm/math-regexp-spaced-after (name symbol)
  (cons (format "\\(\\\\%s \\)" name) symbol))

(defun gm/math-regexp-commands (command open-delim close-delim)
  (list (cons (format "\\([ ]?\\\\%s{\\)" command) open-delim)
        (cons (format "\\\\%s{[^}]*\\(}\\)" command) close-delim)))

(defun gm/prettify-math ()
  (interactive)
  (substitute-patterns-with-unicode-symbol
   (append
    (--map (gm/math-regexp-spaced-after (car it) (cadr it)) gm/spaced-after)
    (-flatten-n 1 (--map (gm/math-regexp-spaced (car it) (cadr it)) gm/math-spaced))
    (-flatten-n 1 (--map (gm/math-regexp-unspaced (car it) (cadr it)) gm/math-unspaced))
    (-flatten-n 1 (--map (gm/math-regexp-commands (car it) (nth 1 it) (nth 2 it)) gm/math-commands))))
  (message "Math prettified."))

(provide 'gm-pretty-math)
